<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS TAKİP SİSTEMİ</title>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --theme-color: #ff0c7a;
            --bg-panel: rgba(10, 15, 20, 0.85);
            --text-main: #ffffff;
            --text-sub: #aaaaaa;
            --border-color: rgba(255, 255, 255, 0.1);
            --font-main: 'Rajdhani', sans-serif;
            --font-header: 'Orbitron', sans-serif;
        }

        body.light-mode {
            --bg-panel: rgba(240, 240, 240, 0.9);
            --text-main: #1a1a1a;
            --text-sub: #555555;
            --border-color: rgba(0, 0, 0, 0.1);
            background-color: #f0f0f0;
            cursor: auto !important;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: var(--font-main);
            color: var(--text-main);
            overflow: hidden;
            cursor: none;
        }

        .scanlines {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            z-index: 2000;
            pointer-events: none;
            opacity: 0.6;
        }

        .tech-grid {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: 
                linear-gradient(var(--border-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.15;
            z-index: 2;
            pointer-events: none;
        }

        #boot-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            color: var(--theme-color);
            transition: opacity 0.8s ease;
        }
        .boot-text { font-size: 1.2rem; width: 320px; }
        .line { 
            margin-bottom: 5px; 
            opacity: 0; 
            animation: typeIn 0.3s forwards; 
        }
        .line:nth-child(1) { animation-delay: 0.2s; }
        .line:nth-child(2) { animation-delay: 0.8s; }
        .line:nth-child(3) { animation-delay: 1.5s; }
        .line:nth-child(4) { animation-delay: 2.2s; }

        .loader-bar {
            width: 100%; height: 4px; background: #333; margin-top: 15px;
            opacity: 0; animation: fadeIn 0.5s forwards 2.5s;
        }
        .bar-fill {
            height: 100%; background: var(--theme-color); width: 0%;
            animation: loadBar 1.5s ease-out forwards 2.5s;
        }

        @keyframes typeIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes loadBar { to { width: 100%; } }

        #custom-cursor {
            position: fixed;
            width: 40px; height: 40px;
            border: 1px dashed var(--theme-color);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            transition: transform 0.1s, border-color 0.2s;
            mix-blend-mode: difference;
        }
        #custom-cursor::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 4px; height: 4px;
            background: var(--theme-color);
            transform: translate(-50%, -50%);
        }

        #map {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        .ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 999;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 350px;
            pointer-events: auto;
            max-height: 95vh;
            overflow-y: auto;
        }

        /* sağ kolon tekrar sağa yaslı */
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 350px;
            pointer-events: auto;
            max-height: 95vh;
            overflow-y: auto;
        }

        .clickable {
            cursor: none;
            transition: transform 0.18s ease;
        }
        .clickable:hover {
            transform: translateY(-1px) scale(1.03);
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--theme-color);
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(8px);
            box-shadow: 0 0 15px rgba(255, 12, 122, 0.2), inset 0 0 20px rgba(0,0,0,0.5); 
            transition: all 0.3s ease;
        }
        .panel.minimized .panel-content { display: none; }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
        h2, h3 {
            font-family: var(--font-header);
            margin: 0;
            color: var(--theme-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1rem;
        }
        h2 {
            animation: glitch 4s infinite;
            text-shadow: 2px 2px 0px rgba(0,255,255,0.3), -2px -2px 0px rgba(255,0,255,0.3);
        }

        .version-badge {
            font-size: 0.6rem;
            background: var(--theme-color);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-sub);
            font-size: 0.9rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        .stat-label { display: flex; align-items: center; gap: 6px; }
        .stat-label i { min-width: 16px; text-align: center; }
        .stat-value {
            font-weight: bold;
            font-family: var(--font-header);
            font-size: 0.9rem;
            color: var(--theme-color);
        }

        .crew-list { list-style: none; margin: 0; padding: 0; }
        .crew-list li {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        .crew-list li i { margin-right: 8px; color: var(--theme-color); }
        .crew-list li:hover {
            background: rgba(128,128,128,0.1);
            color: var(--theme-color);
        }

        .grid-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .color-circle {
            width: 25px; height: 25px;
            border-radius: 50%;
            border: 2px solid transparent;
            margin: auto;
        }
        .color-circle:hover { border-color: var(--text-main); }
        .icon-box {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
        }
        .icon-box:hover { background: var(--theme-color); color: #000; }

        .terminal {
            position: absolute;
            bottom: 20px; left: 20px;
            width: 320px; height: 140px;
            background: rgba(5, 8, 15, 0.94);
            border: 1px solid var(--theme-color);
            color: var(--theme-color);
            padding: 8px 10px;
            font-family: monospace;
            font-size: 0.75rem;
            overflow-y: auto;
            pointer-events: auto;
            border-radius: 8px;
            box-shadow: 0 0 16px rgba(0,0,0,0.6);
            transition: opacity 0.25s ease, transform 0.25s ease;
            z-index: 1200;
        }
        .terminal--hidden { opacity: 0; transform: scale(0.9); pointer-events: none; }

        /* terminal butonu sol panel kolonunun sağına al */
        #terminal-toggle {
            position: absolute;
            bottom: 25px;
            left: 390px; /* 20 padding + 350 left-column + 20 boşluk gibi */
            padding: 6px 12px;
            font-size: 0.75rem;
            background: var(--theme-color);
            color: #000;
            border: none;
            border-radius: 999px;
            z-index: 1300;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 0 14px rgba(0,0,0,0.6);
            pointer-events: auto;
        }

        /* kişisel bilgi kartı biraz yukarı ve dar */
        .personal-info {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 230px;
            background: var(--bg-panel);
            border-right: 4px solid var(--theme-color);
            padding: 15px;
            text-align: right;
            pointer-events: auto;
            border-radius: 6px;
            backdrop-filter: blur(5px);
            font-size: 0.85rem;
            z-index: 1100;
            box-shadow: 0 0 10px rgba(0,0,0,0.4);
        }
        .personal-info h4 {
            margin: 0 0 4px 0;
            color: var(--theme-color);
            font-family: var(--font-header);
            font-size: 1rem;
        }
        .personal-info p { margin: 2px 0; color: var(--text-sub); }

        .pulse-icon {
            font-size: 32px;
            color: var(--theme-color);
            text-shadow: 0 0 15px var(--theme-color);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--theme-color); }

        .settings-toggle {
            position: absolute; top: 14px; right: 14px;
            width: 36px; height: 36px;
            border-radius: 999px; border: none;
            background: rgba(0,0,0,0.7); color: var(--theme-color);
            display: none; align-items: center; justify-content: center;
            z-index: 1400; pointer-events: auto;
        }

        @media (max-width: 900px) {
            body, html { overflow: auto; cursor: auto; }
            #custom-cursor { display: none; }
            .scanlines, .tech-grid { display: none; }
            
            .ui-layer { position: relative; flex-direction: column; padding: 10px; pointer-events: none; }
            .left-column, .right-column { width: 100%; max-height: none; overflow: visible; }
            .panel { margin: 0 5px; }
            #terminal-toggle { bottom: 10px; left: 10px; padding: 6px 10px; }
            .terminal { width: calc(100% - 20px); left: 10px; bottom: 45px; height: 120px; }
            .personal-info { position: static; margin-top: 10px; width: 100%; bottom:auto; }
            .settings-toggle { display: flex; }
            
            body.ui-collapsed .ui-layer,
            body.ui-collapsed #terminal-toggle,
            body.ui-collapsed .terminal,
            body.ui-collapsed .personal-info { display: none; }
        }
        @media (min-width: 901px) { .settings-toggle { display: none; } }

        .hud-corner {
            position: fixed;
            width: 70px;
            height: 70px;
            border: 2px solid var(--theme-color);
            z-index: 1200;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(0,0,0,0.8);
        }
        .hud-corner--tl {
            top: 8px; left: 8px;
            border-right: none; border-bottom: none;
        }
        .hud-corner--tr {
            top: 8px; right: 8px;
            border-left: none; border-bottom: none;
        }
        .hud-corner--bl {
            bottom: 8px; left: 8px;
            border-right: none; border-top: none;
        }
        .hud-corner--br {
            bottom: 8px; right: 8px;
            border-left: none; border-top: none;
        }

        .terminator {
            position: fixed;
            top: -10%; left: -10%;
            width: 120%; height: 120%;
            pointer-events: none;
            z-index: 1;
            background: linear-gradient(90deg,
                rgba(0,0,0,0.65) 0%,
                rgba(0,0,0,0.45) 40%,
                rgba(0,0,0,0.0) 60%,
                rgba(255,255,255,0.0) 100%
            );
            opacity: 0.45;
            mix-blend-mode: multiply;
            transition: transform 1s ease-out;
            transform-origin: 50% 50%;
            filter: blur(2px);
        }

        .solar-bar {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.08);
            overflow: hidden;
            margin-top: 5px;
        }
        .solar-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00ff90, #ffdd00, #ff6600);
            transition: width 0.6s ease-out;
        }
        .panel-note {
            font-size: 0.7rem;
            margin-top: 4px;
            color: var(--text-sub);
        }

        .temp-row {
            flex-direction: column;
            align-items: flex-start;
        }
        .temp-gauge {
            width: 100%;
            height: 10px;
            border-radius: 4px;
            background: rgba(255,255,255,0.08);
            overflow: hidden;
            margin-top: 3px;
        }
        .temp-gauge-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg,#00bcd4,#4caf50,#ffeb3b,#ff5722);
            transition: width 0.5s ease-out;
        }

        #loc-name {
            max-width: 180px;
            display: inline-block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="ui-collapsed">

    <div id="boot-screen">
        <div class="boot-text">
            <div class="line">SYSTEM_CHECK... OK</div>
            <div class="line">CONNECTING_TO_SATELLITE... [25544]</div>
            <div class="line">ENCRYPTING_DATA... DONE</div>
            <div class="line">LOADING_INTERFACE...</div>
            <div class="loader-bar"><div class="bar-fill"></div></div>
        </div>
    </div>

    <div class="scanlines"></div>
    <div class="tech-grid"></div>
    <div id="custom-cursor"></div>

    <div id="map"></div>
    <div id="terminator" class="terminator"></div>

    <div class="hud-corner hud-corner--tl"></div>
    <div class="hud-corner hud-corner--tr"></div>
    <div class="hud-corner hud-corner--bl"></div>
    <div class="hud-corner hud-corner--br"></div>

    <button id="settings-toggle" class="settings-toggle clickable" onclick="toggleMobileUI()">
        <i id="settings-toggle-icon" class="fa-solid fa-gear"></i>
    </button>

    <div class="ui-layer">
        <div class="left-column">
            <div class="panel" id="panel-system">
                <div class="panel-header">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <h2>ISS SİSTEMİ</h2>
                        <span class="version-badge">CANLI</span>
                    </div>
                    <button class="toggle-btn clickable" onclick="togglePanel('panel-system')">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div class="panel-content">
                    <div class="stat-row">
                        <span class="stat-label"><i class="fa-solid fa-arrow-up-long"></i>İrtifa</span>
                        <span class="stat-value" id="alt-val">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label"><i class="fa-solid fa-gauge-high"></i>Hız</span>
                        <span class="stat-value" id="speed-val">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label"><i class="fa-solid fa-arrows-up-down"></i>Enlem</span>
                        <span class="stat-value" id="lat-val">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label"><i class="fa-solid fa-arrows-left-right"></i>Boylam</span>
                        <span class="stat-value" id="lng-val">--</span>
                    </div>

                    <div class="stat-row temp-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-temperature-three-quarters"></i>
                            Dış Sıcaklık (model)
                        </span>
                        <span class="stat-value" id="temp-val">--</span>
                        <div class="temp-gauge">
                            <div id="temp-gauge-fill" class="temp-gauge-fill"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel" id="panel-crew">
                <div class="panel-header">
                    <h3>MÜRETTEBAT</h3>
                    <button class="toggle-btn clickable" onclick="togglePanel('panel-crew')">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div class="panel-content">
                    <ul class="crew-list" id="crew-list"></ul>
                </div>
            </div>

            <div class="panel" id="panel-distances">
                <div class="panel-header">
                    <h3>MESAFELER</h3>
                    <button class="toggle-btn clickable" onclick="togglePanel('panel-distances')">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div class="panel-content" style="font-size:0.9rem; color:var(--text-sub);">
                    <div class="stat-row">
                        <span class="stat-label"><i class="fa-solid fa-person"></i><span>Sana Olan Uzaklık</span></span>
                        <span class="stat-value" id="you-dist-val">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label"><i class="fa-solid fa-earth-europe"></i><span>Dünya'ya Uzaklık</span></span>
                        <span class="stat-value" id="earth-dist-val">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label"><i class="fa-solid fa-moon"></i><span>Ay'a Uzaklık</span></span>
                        <span class="stat-value" id="moon-dist-val">--</span>
                    </div>
                </div>
            </div>

            <div class="panel" id="panel-link">
                <div class="panel-header">
                    <h3>İLETİŞİM</h3>
                    <button class="toggle-btn clickable" onclick="togglePanel('panel-link')">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div class="panel-content">
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-wave-square"></i>Sinyal Gecikmesi
                        </span>
                        <span class="stat-value" id="signal-delay-val">--</span>
                    </div>
                    <p class="panel-note">
                        Not: Boşluktaki ışık hızına göre teorik bir değerdir.
                    </p>
                </div>
            </div>
        </div>

        <div class="right-column">
            <div class="panel" id="panel-settings">
                <div class="panel-header">
                    <h3>SİSTEM AYARLARI</h3>
                    <button class="toggle-btn clickable" onclick="togglePanel('panel-settings')">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div class="panel-content">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <span style="font-size:0.85rem;">ARAYÜZ MODU</span>
                        <button onclick="toggleTheme()" id="theme-toggle-btn" class="clickable"
                            style="padding: 6px 10px; border:none; background: var(--theme-color); border-radius:4px; font-size:0.8rem; font-weight:bold; display:flex; align-items:center; gap:6px;">
                            <i class="fa-solid fa-sun"></i> KARANLIK TEMA
                        </button>
                    </div>

                    <label style="font-size:0.8rem; color:var(--text-sub);">TEMA RENGİ</label>
                    <div class="grid-options" id="color-grid" style="margin-bottom:12px;"></div>

                    <label style="font-size:0.8rem; color:var(--text-sub);">HARİTA İKONU</label>
                    <div class="grid-options" id="icon-grid"></div>
                </div>
            </div>

            <div class="panel" id="panel-time">
                <div class="panel-header">
                    <h3>ZAMAN SİSTEMİ</h3>
                    <button class="toggle-btn clickable" onclick="togglePanel('panel-time')">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div class="panel-content">
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-globe"></i>UTC Saati
                        </span>
                        <span class="stat-value" id="time-utc">--:--:--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-location-crosshairs"></i>Yerel Saat
                        </span>
                        <span class="stat-value" id="time-local">--:--:--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-hourglass-half"></i>Oturum Süresi
                        </span>
                        <span class="stat-value" id="time-session">00:00:00</span>
                    </div>
                </div>
            </div>

            <div class="panel" id="panel-solar">
                <div class="panel-header">
                    <h3>SOLAR ARRAY</h3>
                    <button class="toggle-btn clickable" onclick="togglePanel('panel-solar')">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div class="panel-content">
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-solar-panel"></i>Enerji Üretimi
                        </span>
                        <span class="stat-value" id="solar-eff-val">--</span>
                    </div>
                    <div class="solar-bar">
                        <div id="solar-eff-bar-fill" class="solar-bar-fill"></div>
                    </div>
                    <p class="panel-note">
                        Not: Solar verim, ISS'in gündüz/gece bölgesine göre yaklaşık gösterilir.
                    </p>
                </div>
            </div>

            <div class="panel" id="panel-orbit">
                <div class="panel-header">
                    <h3>YÖRÜNGE VERİLERİ</h3>
                    <button class="toggle-btn clickable" onclick="togglePanel('panel-orbit')">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div class="panel-content">
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-circle-notch"></i>Yörünge Eğikliği
                        </span>
                        <span class="stat-value">51.6°</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-clock-rotate-left"></i>Yörünge Süresi
                        </span>
                        <span class="stat-value">~92 dk</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-sync"></i>Günlük Tur Sayısı
                        </span>
                        <span class="stat-value">~15.5 tur/gün</span>
                    </div>
                    <p class="panel-note">
                        Not: Bu değerler ISS'in bilinen sabit yörünge parametrelerinden alınmıştır, anlık ölçüm değildir.
                    </p>
                </div>
            </div>

            <div class="panel" id="panel-env">
                <div class="panel-header">
                    <h3>KONUM &amp; HAVA</h3>
                    <button class="toggle-btn clickable" onclick="togglePanel('panel-env')">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div class="panel-content">
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-location-dot"></i>Bölge
                        </span>
                        <span class="stat-value" id="loc-name">Hesaplanıyor...</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">
                            <i class="fa-solid fa-cloud-sun"></i>Hava Durumu
                        </span>
                        <span class="stat-value" id="weather-val">--</span>
                    </div>
                </div>
            </div>
        </div>

        <button id="terminal-toggle" class="clickable" onclick="toggleTerminal()">
            <i class="fa-solid fa-terminal"></i>
            <span>Terminal</span>
        </button>

        <div class="terminal" id="terminal">
            <div>[SİSTEM] Başlatılıyor...</div>
        </div>

        <div class="personal-info">
            <h4>Murat Tokaç</h4>
            <p>25370201029</p>
            <p>Arka Yüz Yazılım Geliştirme</p>
            <p>Öğr. Gör. Volkan Cantemir</p>
        </div>
    </div>

<script>
let map, issMarker, polyline;
let pathHistory = [];
let currentIcon = "fa-satellite";
let isLightMode = false;

let fovCircle = null;
let pulsePhase = 0;
let lastEnvUpdateTime = 0;
let isDaySide = true;
let missionStart = Date.now();

const ISS_API_URL = "https://api.wheretheiss.at/v1/satellites/25544";
const MOON_MEAN_DISTANCE_KM = 384400;

let userLat = null;
let userLng = null;

window.onload = () => {
    setTimeout(() => {
        const boot = document.getElementById('boot-screen');
        boot.style.opacity = '0';
        setTimeout(() => { boot.style.display = 'none'; }, 800);
    }, 4500);

    initMap();
    renderCrew();
    renderColors();
    renderIcons();
    initUserLocation();
    startClocks();
    startIssTracking();
    addLog("Sistem başlatıldı. Gerçek ISS telemetrisi etkin.");
};

document.addEventListener('mousemove', (e) => {
    const cursor = document.getElementById('custom-cursor');
    if(isLightMode || window.innerWidth <= 900) {
        cursor.style.display = 'none';
        return;
    }
    cursor.style.display = 'block';
    cursor.style.left = e.clientX + 'px';
    cursor.style.top = e.clientY + 'px';
});

document.addEventListener('mousedown', () => {
    if(!isLightMode) document.getElementById('custom-cursor').style.transform = 'translate(-50%, -50%) scale(0.8)';
});
document.addEventListener('mouseup', () => {
    if(!isLightMode) document.getElementById('custom-cursor').style.transform = 'translate(-50%, -50%) scale(1)';
});

function initMap() {
    map = L.map("map", {
        zoomControl: false,
        attributionControl: false
    }).setView([0, 0], 3);

    setMapTiles(false);

    polyline = L.polyline(
        [],
        {
            color: getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim(),
            weight: 2
        }
    ).addTo(map);

    createMarker([0, 0]);
}

function setMapTiles(light) {
    map.eachLayer(l => { if (l instanceof L.TileLayer) map.removeLayer(l); });
    const url = light
        ? "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"
        : "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
    L.tileLayer(url, { maxZoom: 19 }).addTo(map);
}

function createMarker(latlng) {
    if (issMarker) map.removeLayer(issMarker);
    const iconHtml = `<i class="fa-solid ${currentIcon} pulse-icon"></i>`;
    const divIcon = L.divIcon({
        html: iconHtml,
        className: "",
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });
    issMarker = L.marker(latlng, { icon: divIcon }).addTo(map);
}

function hackerTextEffect(elementId, newValue) {
    const element = document.getElementById(elementId);
    if(!element) return;
    
    const originalText = newValue;
    let iterations = 0;
    const interval = setInterval(() => {
        element.innerText = element.innerText.split("")
            .map((letter, index) => {
                if(index < iterations) return originalText[index];
                return Math.floor(Math.random() * 10);
            })
            .join("");
        
        if(iterations >= originalText.length) {
            element.innerText = originalText;
            clearInterval(interval);
        }
        iterations += 1/2; 
    }, 30);
}

function startClocks() {
    updateClocks();
    setInterval(updateClocks, 1000);
}

function pad2(n) { return n.toString().padStart(2, "0"); }

function updateClocks() {
    const now = new Date();

    const utcStr = now.toLocaleTimeString("tr-TR", {
        timeZone: "UTC",
        hour12: false
    });
    const localStr = now.toLocaleTimeString("tr-TR", {
        hour12: false
    });

    const sessionMs = Date.now() - missionStart;
    const s = Math.floor(sessionMs / 1000);
    const hh = pad2(Math.floor(s / 3600));
    const mm = pad2(Math.floor((s % 3600) / 60));
    const ss = pad2(s % 60);

    document.getElementById("time-utc").innerText = utcStr;
    document.getElementById("time-local").innerText = localStr;
    document.getElementById("time-session").innerText = `${hh}:${mm}:${ss}`;
}

function startIssTracking() {
    fetchAndUpdateIss();
    setInterval(fetchAndUpdateIss, 3000);
}

async function fetchAndUpdateIss() {
    try {
        const response = await fetch(ISS_API_URL);
        const data = await response.json();

        const lat = data.latitude;
        const lng = data.longitude;
        const alt = data.altitude;
        const speed = data.velocity;

        const pos = [lat, lng];

        issMarker.setLatLng(pos);
        pathHistory.push(pos);
        if (pathHistory.length > 120) pathHistory.shift();
        polyline.setLatLngs(pathHistory);

        updateFovCircle(lat, lng);

        const temp = computeExteriorTemp(lat);
        updateTemperatureUI(temp);

        updateDayNightAndSolar(lat, lng);

        const now = Date.now();
        if (now - lastEnvUpdateTime > 60000) {
            lastEnvUpdateTime = now;
            updateEnvironment(lat, lng);
        }

        hackerTextEffect("lat-val", lat.toFixed(4));
        hackerTextEffect("lng-val", lng.toFixed(4));
        hackerTextEffect("alt-val", alt.toFixed(1) + " km");
        hackerTextEffect("speed-val", speed.toFixed(0) + " km/h");

        const earthDist = alt;
        document.getElementById("earth-dist-val").innerText = earthDist.toFixed(1) + " km";

        const moonDist = MOON_MEAN_DISTANCE_KM - earthDist;
        document.getElementById("moon-dist-val").innerText = moonDist.toFixed(0) + " km";

        if (userLat !== null && userLng !== null) {
            const d = getDistanceKm(userLat, userLng, lat, lng);
            document.getElementById("you-dist-val").innerText = d.toFixed(0) + " km";
            updateSignalDelay(d);
        }

        addLog(`KONUM: ${lat.toFixed(2)}, ${lng.toFixed(2)} | İrtifa: ${alt.toFixed(1)} km`);

    } catch (e) {
        addLog("HATA: ISS konumu alınamadı.");
        console.error(e);
    }
}

function initUserLocation() {
    if (!navigator.geolocation) {
        addLog("Tarayıcı konum servisini desteklemiyor.");
        return;
    }
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
            addLog("Kullanıcı konumu alındı.");
        },
        () => { addLog("Kullanıcı konumu alınamadı."); }
    );
}

function getDistanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lat2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function togglePanel(id) {
    const p = document.getElementById(id);
    p.classList.toggle("minimized");
    const btnIcon = p.querySelector(".toggle-btn i");
    btnIcon.className = p.classList.contains("minimized")
        ? "fa-solid fa-plus" : "fa-solid fa-minus";
}

function addLog(msg) {
    const term = document.getElementById("terminal");
    const t = new Date().toLocaleTimeString("tr-TR");
    const div = document.createElement("div");
    div.innerHTML = `[${t}] ${msg}`;
    term.appendChild(div);
    term.scrollTop = term.scrollHeight;
}

function toggleTerminal() {
    const term = document.getElementById("terminal");
    term.classList.toggle("terminal--hidden");
}

function toggleMobileUI() {
    document.body.classList.toggle("ui-collapsed");
    const icon = document.getElementById("settings-toggle-icon");
    icon.className = document.body.classList.contains("ui-collapsed")
        ? "fa-solid fa-gear"
        : "fa-solid fa-xmark";
}

function renderCrew() {
    const crew = [
        "Oleg Kononenko","Nikolai Chub","Loral O'Hara",
        "Jasmin Moghbeli","Satoshi Furukawa","Konstantin Borisov","Andreas Mogensen"
    ];
    const list = document.getElementById("crew-list");
    crew.forEach(name => {
        const li = document.createElement("li");
        li.className = "clickable";
        li.innerHTML = `<i class="fa-solid fa-user-astronaut"></i> ${name}`;
        li.onclick = () => {
            window.open(`https://tr.wikipedia.org/wiki/${name.replace(/ /g,"_")}`, "_blank");
            addLog(`Wikipedia açılıyor: ${name}`);
        };
        list.appendChild(li);
    });
}

function toggleTheme() {
    isLightMode = !isLightMode;
    const btn = document.getElementById("theme-toggle-btn");
    const cursor = document.getElementById('custom-cursor');

    if (isLightMode) {
        document.body.classList.add("light-mode");
        setMapTiles(true);
        btn.innerHTML = '<i class="fa-solid fa-moon"></i> AYDINLIK TEMA';
        btn.style.background = "#333";
        btn.style.color = "#fff";
        document.body.style.cursor = "auto";
        cursor.style.display = 'none';
    } else {
        document.body.classList.remove("light-mode");
        setMapTiles(false);
        btn.innerHTML = '<i class="fa-solid fa-sun"></i> KARANLIK TEMA';
        btn.style.background = "var(--theme-color)";
        btn.style.color = "#000";
        document.body.style.cursor = "none";
        cursor.style.display = 'block';
    }
    addLog(`Tema değiştirildi: ${isLightMode ? "Aydınlık" : "Karanlık"}`);
}

function renderColors() {
    const colors = [
        "#ff0c7a","#00d2ff","#ff0055","#ffcc00",
        "#9d00ff","#ffffff","#ff6600","#00ff00",
        "#ff00ff","#00ffff","#ffff00","#ff0000"
    ];
    const grid = document.getElementById("color-grid");
    colors.forEach(c => {
        const div = document.createElement("div");
        div.className = "color-circle clickable";
        div.style.background = c;
        div.onclick = () => {
            document.documentElement.style.setProperty("--theme-color", c);
            polyline.setStyle({ color: c });
            if (fovCircle) {
                fovCircle.setStyle({ color: c, fillColor: c });
            }
            addLog(`Tema rengi güncellendi: ${c}`);
        };
        grid.appendChild(div);
    });
}

function renderIcons() {
    const icons = [
        "fa-satellite","fa-rocket","fa-user-astronaut",
        "fa-meteor","fa-earth-americas","fa-globe","fa-shuttle-space"
    ];
    const grid = document.getElementById("icon-grid");
    icons.forEach(i => {
        const div = document.createElement("div");
        div.className = "icon-box clickable";
        div.innerHTML = `<i class="fa-solid ${i}"></i>`;
        div.onclick = () => {
            currentIcon = i;
            createMarker(issMarker.getLatLng());
            addLog(`İkon değiştirildi: ${i}`);
        };
        grid.appendChild(div);
    });
}

/* === Pulsing Tarama Halkası (pixel bazlı, ISS tam ortada) === */
function updateFovCircle(lat, lng) {
    const themeColor = getComputedStyle(document.documentElement)
        .getPropertyValue('--theme-color').trim();

    const baseRadius = 50;  // px
    const delta = 15;       // px
    pulsePhase = (pulsePhase + 0.4) % (Math.PI * 2);
    const radius = baseRadius + Math.sin(pulsePhase) * delta;

    if (!fovCircle) {
        fovCircle = L.circleMarker([lat, lng], {
            radius: radius,
            color: themeColor,
            weight: 1,
            fillColor: themeColor,
            fillOpacity: 0.12,
            interactive: false
        }).addTo(map);
    } else {
        fovCircle.setLatLng([lat, lng]);
        fovCircle.setRadius(radius);
        fovCircle.setStyle({ color: themeColor, fillColor: themeColor });
    }
}

function computeExteriorTemp(lat) {
    const base = -80;
    const amplitude = 35;
    const factor = Math.cos(Math.abs(lat) * Math.PI / 180);
    return base + amplitude * factor;
}

function updateTemperatureUI(temp) {
    const text = temp.toFixed(1) + " °C";
    hackerTextEffect("temp-val", text);

    const minT = -80;
    const maxT = -40;
    const clamped = Math.min(maxT, Math.max(minT, temp));
    const perc = ((clamped - minT) / (maxT - minT)) * 100;

    document.getElementById("temp-gauge-fill").style.width = perc + "%";
}

function updateDayNightAndSolar(lat, lng) {
    const terminator = document.getElementById('terminator');
    if (terminator) {
        terminator.style.transform = `rotate(${lng}deg)`;
    }

    const dayFactor = Math.cos((lng * Math.PI) / 180);
    isDaySide = dayFactor > 0;

    let solarEff = isDaySide ? 100 : 12;
    document.getElementById("solar-eff-val").innerText =
        solarEff + "% " + (isDaySide ? "(Gündüz)" : "(Gece)");
    document.getElementById("solar-eff-bar-fill").style.width = solarEff + "%";
}

function updateSignalDelay(distanceKm) {
    const c_km_s = 299792.458;
    const delayMs = (distanceKm / c_km_s) * 1000;
    document.getElementById("signal-delay-val").innerText =
        delayMs.toFixed(2) + " ms (teorik)";
}

async function updateEnvironment(lat, lng) {
    try {
        let locationLabel = "Okyanus Üzeri";

        try {
            const revRes = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=5&addressdetails=1`
            );
            const revData = await revRes.json();
            const addr = revData.address || {};
            const city = addr.city || addr.town || addr.village || addr.hamlet || addr.county;
            const country = addr.country || "";
            if (country || city) {
                locationLabel = (city ? city + ", " : "") + country;
            }
        } catch (e) {
            console.warn("Reverse geocoding başarısız", e);
        }

        document.getElementById("loc-name").innerText = locationLabel;

        try {
            const wRes = await fetch(
                `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`
            );
            const wData = await wRes.json();
            if (wData && wData.current_weather) {
                const t = wData.current_weather.temperature;
                const code = wData.current_weather.weathercode;
                const desc = weatherCodeToText(code);
                document.getElementById("weather-val").innerText =
                    `${t.toFixed(1)}°C, ${desc}`;
            }
        } catch (e) {
            console.warn("Hava durumu alınamadı", e);
        }

        addLog("Konum & hava bilgisi güncellendi.");
    } catch (e) {
        addLog("Konum/hava verisi alınamadı.");
        console.error(e);
    }
}

function weatherCodeToText(code) {
    if (code === 0) return "Açık";
    if (code === 1 || code === 2) return "Parçalı Bulutlu";
    if (code === 3) return "Bulutlu";
    if (code === 45 || code === 48) return "Sisli";
    if (code === 51 || code === 53 || code === 55) return "Çiseleme";
    if (code === 61 || code === 63 || code === 65) return "Yağmurlu";
    if (code === 66 || code === 67) return "Dondurucu Yağmur";
    if (code === 71 || code === 73 || code === 75) return "Karlı";
    if (code === 95) return "Gök Gürültülü Sağanak";
    if (code === 96 || code === 99) return "Dolu Yağışlı Fırtına";
    return "Bilinmeyen Durum";
}
</script>
</body>
</html>
